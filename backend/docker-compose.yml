version: '3'

services:
  # ==============================
  # API 网关 (Nginx)
  # ==============================
  # 职责：
  # 1. 统一对外暴露端口 (8888)
  # 2. 反向代理到宿主机运行的 Go 服务 (通过 host.docker.internal)
  # 3. 静态资源托管 (前端文件)
  nginx:
    image: nginx:1.21-alpine
    container_name: wb-gateway
    restart: always
    ports:
      - "8888:8080" # 浏览器访问 http://localhost:8888
    volumes:
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./data/logs/nginx:/var/log/nginx
    # -----------------------------------------------------------
    # 核心配置：打通容器与宿主机网络
    # -----------------------------------------------------------
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - wb-net

  # ==============================
  # [可选] 链路追踪 (Jaeger)
  # ==============================
  # go-zero 默认集成 jaeger，开发时非常有用
  # jaeger:
  #   image: jaegertracing/all-in-one:1.38
  #   container_name: wb-jaeger
  #   ports:
  #     - "5775:5775/udp"
  #     - "6831:6831/udp"
  #     - "6832:6832/udp"
  #     - "5778:5778"
  #     - "16686:16686" # Web UI
  #     - "14268:14268"
  #     - "9411:9411"
  #   networks:
  #     - wb-net

  # ==============================
  # [可选] 监控 (Prometheus)
  # ==============================
  # prometheus:
  #   image: prom/prometheus:v2.39.1
  #   container_name: wb-prometheus
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #   networks:
  #     - wb-net

# ==============================
# 网络配置
# ==============================
# 关键：声明使用外部已存在的网络 (由 env 文件创建)
networks:
  wb-net:
    external: true
    name: whiteboard-net