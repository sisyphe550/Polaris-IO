# Search æœåŠ¡å®Œæ•´è®¾è®¡è§£æ

## 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    Search æœåŠ¡                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         RPC è°ƒç”¨        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     search-api      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚            search-rpc               â”‚â”‚
â”‚  â”‚   (HTTP Gateway)    â”‚                         â”‚           (æœç´¢æ ¸å¿ƒ)                 â”‚â”‚
â”‚  â”‚   Port: 1004        â”‚                         â”‚           Port: 2004                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚           â”‚                                                      â”‚                      â”‚
â”‚           â”‚                                                      â”‚                      â”‚
â”‚           â–¼                                                      â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   JWT è®¤è¯ä¸­é—´ä»¶     â”‚                         â”‚          Elasticsearch              â”‚â”‚
â”‚  â”‚                     â”‚                         â”‚          polaris_file ç´¢å¼•          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚          (æ–‡ä»¶å…¨æ–‡æœç´¢)              â”‚â”‚
â”‚                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â–²                      â”‚
â”‚                                                                  â”‚                      â”‚
â”‚                                                                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                              search-job (Kafka Consumer)                             â”‚â”‚
â”‚  â”‚                                                                                      â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚   â”‚      Kafka      â”‚  â”€â”€â”€â”€ æ¶ˆè´¹äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚        FileEventHandler            â”‚â”‚â”‚
â”‚  â”‚   â”‚ polaris-file-   â”‚                         â”‚  - file_uploaded â†’ åˆ›å»ºç´¢å¼•        â”‚â”‚â”‚
â”‚  â”‚   â”‚    event        â”‚                         â”‚  - file_updated â†’ æ›´æ–°ç´¢å¼•         â”‚â”‚â”‚
â”‚  â”‚   â”‚   (file-rpc     â”‚                         â”‚  - file_deleted â†’ åˆ é™¤ç´¢å¼•         â”‚â”‚â”‚
â”‚  â”‚   â”‚   ç”Ÿäº§çš„äº‹ä»¶)    â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ•°æ®æ¨¡å‹

### 2.1 Elasticsearch: polaris_file ç´¢å¼•

```json
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0,
    "analysis": {
      "analyzer": {
        "filename_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase", "edge_ngram_filter"]
        },
        "filename_search_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase"]
        }
      },
      "filter": {
        "edge_ngram_filter": {
          "type": "edge_ngram",
          "min_gram": 1,
          "max_gram": 20
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "id":          { "type": "keyword" },
      "user_id":     { "type": "long" },
      "file_id":     { "type": "long" },
      "name":        { 
        "type": "text",
        "analyzer": "filename_analyzer",
        "search_analyzer": "filename_search_analyzer",
        "fields": { "keyword": { "type": "keyword" } }
      },
      "name_pinyin": { "type": "text", "analyzer": "filename_analyzer" },
      "ext":         { "type": "keyword" },
      "size":        { "type": "long" },
      "hash":        { "type": "keyword" },
      "parent_id":   { "type": "long" },
      "is_dir":      { "type": "boolean" },
      "create_time": { "type": "date" },
      "update_time": { "type": "date" }
    }
  }
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `id`ï¼šæ–‡ä»¶ identityï¼ˆUUIDï¼‰ï¼Œä½œä¸º ES æ–‡æ¡£ `_id`
- `user_id`ï¼šç”¨äºéš”ç¦»ä¸åŒç”¨æˆ·çš„æœç´¢ç»“æœ
- `name`ï¼šä½¿ç”¨è‡ªå®šä¹‰åˆ†è¯å™¨æ”¯æŒå‰ç¼€æœç´¢
- `name_pinyin`ï¼šæ‹¼éŸ³å­—æ®µï¼Œæ”¯æŒæ‹¼éŸ³æœç´¢ï¼ˆé¢„ç•™ï¼‰
- `ext`ï¼škeyword ç±»å‹ï¼Œç”¨äºç²¾ç¡®è¿‡æ»¤
- Edge N-gramï¼šæ”¯æŒè¾“å…¥å³æœç´¢ï¼ˆautocompleteï¼‰

### 2.2 FileDocument æ–‡æ¡£ç»“æ„

```go
type FileDocument struct {
    ID         string    `json:"id"`          // æ–‡ä»¶ identity (ES _id)
    UserID     int64     `json:"user_id"`     // ç”¨æˆ·ID
    FileID     int64     `json:"file_id"`     // MySQL file_id
    Name       string    `json:"name"`        // æ–‡ä»¶åï¼ˆç”¨äºæœç´¢ï¼‰
    NamePinyin string    `json:"name_pinyin"` // æ–‡ä»¶åæ‹¼éŸ³ï¼ˆç”¨äºæ‹¼éŸ³æœç´¢ï¼‰
    Ext        string    `json:"ext"`         // æ‰©å±•å
    Size       uint64    `json:"size"`        // æ–‡ä»¶å¤§å°
    Hash       string    `json:"hash"`        // æ–‡ä»¶å“ˆå¸Œ
    ParentID   int64     `json:"parent_id"`   // çˆ¶ç›®å½•ID
    IsDir      bool      `json:"is_dir"`      // æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
    CreateTime time.Time `json:"create_time"` // åˆ›å»ºæ—¶é—´
    UpdateTime time.Time `json:"update_time"` // æ›´æ–°æ—¶é—´
}
```

---

## 3. æœåŠ¡ç»„ä»¶

### 3.1 ä¸‰å¤§ç»„ä»¶

| ç»„ä»¶ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| search-api | 1004 | HTTP ç½‘å…³ï¼Œå¯¹å¤–æä¾›æœç´¢æ¥å£ |
| search-rpc | 2004 | gRPC æœåŠ¡ï¼Œæœç´¢æ ¸å¿ƒé€»è¾‘ |
| search-job | - | Kafka æ¶ˆè´¹è€…ï¼Œå®æ—¶åŒæ­¥æ–‡ä»¶ç´¢å¼• |

### 3.2 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                æ•°æ®åŒæ­¥æµç¨‹                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

file-rpc (ç”Ÿäº§è€…)                      search-job (æ¶ˆè´¹è€…)               Elasticsearch
      â”‚                                       â”‚                              â”‚
      â”‚  file_uploaded                        â”‚                              â”‚
      â”‚  {identity, name, size, ...}          â”‚                              â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
      â”‚              Kafka                    â”‚   IndexDocument              â”‚
      â”‚                                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                       â”‚                              â”‚
      â”‚  file_updated                         â”‚                              â”‚
      â”‚  {identity, name, parent_id}          â”‚                              â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
      â”‚                                       â”‚   UpdateDocument             â”‚
      â”‚                                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                       â”‚                              â”‚
      â”‚  file_deleted                         â”‚                              â”‚
      â”‚  {identity}                           â”‚                              â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
      â”‚                                       â”‚   DeleteDocument             â”‚
      â”‚                                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

---

## 4. API æ¥å£è®¾è®¡

### 4.1 å¯¹å¤– HTTP æ¥å£ (search-api)

| æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|------|------|------|------|
| GET | `/search/v1/files` | âœ… JWT | æœç´¢æ–‡ä»¶ |
| GET | `/search/v1/stats` | âœ… JWT | è·å–ç”¨æˆ·æ–‡ä»¶ç»Ÿè®¡ |

### 4.2 æœç´¢å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| keyword | string | æœç´¢å…³é”®è¯ï¼ˆæ–‡ä»¶åï¼‰ |
| ext | []string | æ‰©å±•åè¿‡æ»¤ï¼ˆå¦‚ pdf, docxï¼‰ |
| isDir | bool | æ˜¯å¦åªæœç´¢æ–‡ä»¶å¤¹ |
| minSize | uint64 | æœ€å°æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| maxSize | uint64 | æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| page | int | é¡µç ï¼ˆé»˜è®¤ 1ï¼‰ |
| pageSize | int | æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 20ï¼Œæœ€å¤§ 100ï¼‰ |
| sortBy | string | æ’åºå­—æ®µï¼šname, size, create_time, update_time |
| sortDesc | bool | æ˜¯å¦é™åº |

### 4.3 å†…éƒ¨ RPC æ¥å£ (search-rpc)

| åˆ†ç±» | æ–¹æ³• | è°ƒç”¨è€… | è¯´æ˜ |
|------|------|--------|------|
| **æœç´¢** | `SearchFiles` | search-api | æ–‡ä»¶æœç´¢ |
| | `GetUserStats` | search-api | ç”¨æˆ·æ–‡ä»¶ç»Ÿè®¡ |
| **ç´¢å¼•ç®¡ç†** | `IndexFile` | file-rpc (å¤‡é€‰) | åˆ›å»ºæ–‡ä»¶ç´¢å¼• |
| | `UpdateFileIndex` | file-rpc (å¤‡é€‰) | æ›´æ–°æ–‡ä»¶ç´¢å¼• |
| | `DeleteFileIndex` | file-rpc (å¤‡é€‰) | åˆ é™¤æ–‡ä»¶ç´¢å¼• |

---

## 5. æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 5.1 æ–‡ä»¶æœç´¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SearchFiles æµç¨‹                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¯·æ±‚ â”€â”€> search-api â”€â”€> search-rpc â”€â”€> Elasticsearch
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 1. æ„å»º Bool æŸ¥è¯¢         â”‚
                    â”‚    must: user_id = ?     â”‚
                    â”‚    must: keyword match   â”‚
                    â”‚    filter: ext, size...  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 2. è®¾ç½®åˆ†é¡µå’Œæ’åº         â”‚
                    â”‚    from: (page-1)*size   â”‚
                    â”‚    size: pageSize        â”‚
                    â”‚    sort: sortBy          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. é«˜äº®è®¾ç½®              â”‚
                    â”‚    highlight: name       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 4. æ‰§è¡Œæœç´¢              â”‚
                    â”‚    ES Search API        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 5. è¿”å›ç»“æœ              â”‚
                    â”‚    {total, list}        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æœç´¢æŸ¥è¯¢æ„å»º

```go
// æœç´¢æŸ¥è¯¢ç¤ºä¾‹
{
  "query": {
    "bool": {
      "must": [
        { "term": { "user_id": 123 } },
        {
          "bool": {
            "should": [
              { "match": { "name": { "query": "æŠ¥å‘Š", "boost": 2.0, "fuzziness": "AUTO" } } },
              { "match": { "name_pinyin": { "query": "baogao", "fuzziness": "AUTO" } } },
              { "wildcard": { "name.keyword": { "value": "*æŠ¥å‘Š*", "case_insensitive": true } } }
            ],
            "minimum_should_match": 1
          }
        }
      ],
      "filter": [
        { "terms": { "ext": ["pdf", "docx"] } },
        { "range": { "size": { "gte": 1024, "lte": 10485760 } } }
      ]
    }
  },
  "from": 0,
  "size": 20,
  "sort": [
    { "_score": { "order": "desc" } },
    { "update_time": { "order": "desc" } }
  ],
  "highlight": {
    "fields": {
      "name": { "pre_tags": ["<em>"], "post_tags": ["</em>"] }
    }
  }
}
```

### 5.3 Kafka äº‹ä»¶å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FileEventHandler æµç¨‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Kafka Message â”€â”€> search-job
                      â”‚
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ è§£æ FileEvent   â”‚
            â”‚ json.Unmarshal   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚file_uploadedâ”‚ â”‚file_updatedâ”‚ â”‚file_deletedâ”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚IndexDocumentâ”‚ â”‚UpdateDocumentâ”‚ â”‚DeleteDocumentâ”‚
 â”‚  åˆ›å»ºç´¢å¼•   â”‚ â”‚  æ›´æ–°å­—æ®µ   â”‚ â”‚  åˆ é™¤ç´¢å¼•   â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 Kafka äº‹ä»¶æ ¼å¼

```json
// file_uploaded - æ–‡ä»¶ä¸Šä¼ å®Œæˆ
{
  "event_type": "file_uploaded",
  "user_id": 123,
  "file_id": 456,
  "identity": "uuid-xxx",
  "name": "å¹´åº¦æŠ¥å‘Š.pdf",
  "hash": "sha256...",
  "size": 1024000,
  "ext": "pdf",
  "parent_id": 0,
  "timestamp": "2026-01-15T10:30:00Z"
}

// file_updated - æ–‡ä»¶æ›´æ–°ï¼ˆç§»åŠ¨/é‡å‘½åï¼‰
{
  "event_type": "file_updated",
  "user_id": 123,
  "file_id": 456,
  "identity": "uuid-xxx",
  "name": "å­£åº¦æŠ¥å‘Š.pdf",
  "parent_id": 789,
  "timestamp": "2026-01-15T11:00:00Z"
}

// file_deleted - æ–‡ä»¶åˆ é™¤
{
  "event_type": "file_deleted",
  "user_id": 123,
  "file_id": 456,
  "identity": "uuid-xxx",
  "timestamp": "2026-01-15T11:30:00Z"
}
```

---

## 6. è·¨æœåŠ¡è°ƒç”¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æœåŠ¡ä¾èµ–å…³ç³»å›¾                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚              file-rpc                 â”‚
                         â”‚              Port: 2002               â”‚
                         â”‚              (ç”Ÿäº§è€…)                  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ polaris-file-event
                                          â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚               Kafka                   â”‚
                         â”‚         polaris-file-event           â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ æ¶ˆè´¹
                                          â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚             search-job                â”‚
                         â”‚              (æ¶ˆè´¹è€…)                  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ ç´¢å¼•æ“ä½œ
                                          â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚           Elasticsearch               â”‚
                         â”‚           polaris_file ç´¢å¼•          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–²
                                          â”‚ æœç´¢æŸ¥è¯¢
                                          â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚             search-rpc                â”‚
                         â”‚              Port: 2004               â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–²
                                          â”‚ RPC è°ƒç”¨
                                          â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚             search-api                â”‚
                         â”‚              Port: 1004               â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å¯ä¼˜åŒ–ç‚¹åˆ†æ

### ğŸ”´ é«˜ä¼˜å…ˆçº§

#### 7.1 ç¼ºå°‘æœç´¢ç»“æœç¼“å­˜

**å½“å‰é—®é¢˜**ï¼šæ¯æ¬¡æœç´¢éƒ½æŸ¥è¯¢ Elasticsearch

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```go
// çƒ­é—¨æœç´¢ç¼“å­˜ï¼ˆçŸ­æ—¶é—´ï¼Œå¦‚ 1 åˆ†é’Ÿï¼‰
key := fmt.Sprintf("search:%d:%s:%d:%d", userId, keyword, page, pageSize)
cached, err := redis.Get(key)
if err == nil && cached != "" {
    return unmarshal(cached), nil
}
// æŸ¥è¯¢ ES åå†™å…¥ç¼“å­˜
redis.Setex(key, json.Marshal(result), 60)
```

#### 7.2 æ‹¼éŸ³æœç´¢æœªå®ç°

**å½“å‰é—®é¢˜**ï¼š`name_pinyin` å­—æ®µæœªå¡«å……

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```go
import "github.com/mozillazg/go-pinyin"

// ç´¢å¼•æ—¶è½¬æ¢æ‹¼éŸ³
args := pinyin.NewArgs()
py := pinyin.Pinyin(name, args)
doc.NamePinyin = strings.Join(flatten(py), "")
```

#### 7.3 Kafka æ¶ˆè´¹å¤±è´¥æ— é‡è¯•

**å½“å‰é—®é¢˜**ï¼šæ¶ˆè´¹å¤±è´¥ç›´æ¥è¿”å› error

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```go
// ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—
if err := h.handleEvent(event); err != nil {
    // é‡è¯• 3 æ¬¡
    for i := 0; i < 3; i++ {
        if err = h.handleEvent(event); err == nil {
            break
        }
        time.Sleep(time.Second * time.Duration(i+1))
    }
    // ä»ç„¶å¤±è´¥ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
    if err != nil {
        h.svcCtx.KafkaProducer.Send("polaris-file-event-dlq", msg)
    }
}
```

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

#### 7.4 ç¼ºå°‘æœç´¢å»ºè®®ï¼ˆSuggestï¼‰

**å½“å‰é—®é¢˜**ï¼šåªæœ‰æœç´¢ï¼Œæ²¡æœ‰æœç´¢å»ºè®®

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```json
// ES Completion Suggester
{
  "suggest": {
    "file-suggest": {
      "prefix": "æŠ¥",
      "completion": {
        "field": "name.suggest",
        "size": 10
      }
    }
  }
}
```

#### 7.5 ç¼ºå°‘æœç´¢å†å²

**å½“å‰é—®é¢˜**ï¼šç”¨æˆ·æ— æ³•æŸ¥çœ‹æœç´¢å†å²

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```go
// Redis List è®°å½•æœç´¢å†å²
key := fmt.Sprintf("search:history:%d", userId)
redis.LPush(key, keyword)
redis.LTrim(key, 0, 49)  // ä¿ç•™æœ€è¿‘ 50 æ¡
```

#### 7.6 ç¼ºå°‘æ–‡ä»¶å†…å®¹æœç´¢

**å½“å‰é—®é¢˜**ï¼šåªèƒ½æœç´¢æ–‡ä»¶å

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- é›†æˆ Tika æˆ– Apache POI æå–æ–‡æ¡£å†…å®¹
- æ·»åŠ  `content` å­—æ®µåˆ°ç´¢å¼•
- å¤§æ–‡ä»¶å†…å®¹å­˜å‚¨åˆ°å•ç‹¬ç´¢å¼•

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

#### 7.7 ç¼ºå°‘æœç´¢åˆ†æ

**å½“å‰é—®é¢˜**ï¼šæ²¡æœ‰æœç´¢æ•°æ®åˆ†æ

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- è®°å½•æœç´¢å…³é”®è¯é¢‘ç‡
- è®°å½•ç‚¹å‡»ç‡
- çƒ­é—¨æœç´¢æ¦œå•

#### 7.8 ç¼ºå°‘é«˜çº§æœç´¢è¯­æ³•

**å½“å‰é—®é¢˜**ï¼šåªæ”¯æŒç®€å•å…³é”®è¯æœç´¢

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```
æ”¯æŒè¯­æ³•ï¼š
- "ç²¾ç¡®æœç´¢"ï¼ˆå¼•å·åŒ…å›´ï¼‰
- file:pdfï¼ˆæŒ‰ç±»å‹ï¼‰
- size:>1MBï¼ˆæŒ‰å¤§å°ï¼‰
- date:2026-01ï¼ˆæŒ‰æ—¥æœŸï¼‰
```

#### 7.9 ç¼ºå°‘æœç´¢ç»“æœæ’åºä¼˜åŒ–

**å½“å‰é—®é¢˜**ï¼šç®€å•çš„ç›¸å…³æ€§æ’åº

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- æœ€è¿‘è®¿é—®ä¼˜å…ˆ
- å¸¸ç”¨æ–‡ä»¶ä¼˜å…ˆ
- ä¸ªæ€§åŒ–æ’åº

---

## 8. ä¼˜åŒ–ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | å½±å“ | å¤æ‚åº¦ |
|--------|--------|------|--------|
| ğŸ”´ é«˜ | æœç´¢ç»“æœç¼“å­˜ | æ€§èƒ½ | ä½ |
| ğŸ”´ é«˜ | æ‹¼éŸ³æœç´¢ | ç”¨æˆ·ä½“éªŒ | ä½ |
| ğŸ”´ é«˜ | Kafka æ¶ˆè´¹é‡è¯•/æ­»ä¿¡é˜Ÿåˆ— | å¯é æ€§ | ä¸­ |
| ğŸŸ¡ ä¸­ | æœç´¢å»ºè®® (Suggest) | ç”¨æˆ·ä½“éªŒ | ä¸­ |
| ğŸŸ¡ ä¸­ | æœç´¢å†å² | ç”¨æˆ·ä½“éªŒ | ä½ |
| ğŸŸ¡ ä¸­ | æ–‡ä»¶å†…å®¹æœç´¢ | åŠŸèƒ½å®Œæ•´æ€§ | é«˜ |
| ğŸŸ¢ ä½ | æœç´¢åˆ†æ | è¿è¥æ”¯æŒ | ä¸­ |
| ğŸŸ¢ ä½ | é«˜çº§æœç´¢è¯­æ³• | ç”¨æˆ·ä½“éªŒ | ä¸­ |
| ğŸŸ¢ ä½ | ä¸ªæ€§åŒ–æ’åº | ç”¨æˆ·ä½“éªŒ | é«˜ |

---

## 9. å½“å‰è®¾è®¡çš„ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… å®æ—¶åŒæ­¥ | Kafka äº‹ä»¶é©±åŠ¨ï¼Œæ–‡ä»¶å˜æ›´å®æ—¶åŒæ­¥åˆ° ES |
| âœ… æ•°æ®éš”ç¦» | é€šè¿‡ user_id ä¸¥æ ¼éš”ç¦»ä¸åŒç”¨æˆ·çš„æœç´¢ç»“æœ |
| âœ… çµæ´»æœç´¢ | æ”¯æŒå…³é”®è¯ã€æ‰©å±•åã€å¤§å°ã€ç±»å‹ç­‰å¤šç»´åº¦è¿‡æ»¤ |
| âœ… æ¨¡ç³ŠåŒ¹é… | æ”¯æŒ fuzzy æœç´¢ï¼Œå®¹å¿è¾“å…¥é”™è¯¯ |
| âœ… å‰ç¼€æœç´¢ | Edge N-gram æ”¯æŒè¾“å…¥å³æœç´¢ |
| âœ… é«˜äº®æ˜¾ç¤º | æœç´¢ç»“æœé«˜äº®åŒ¹é…å…³é”®è¯ |
| âœ… è§£è€¦è®¾è®¡ | search-job ç‹¬ç«‹æ¶ˆè´¹ï¼Œä¸å½±å“ä¸»æµç¨‹ |
| âœ… å¤‡é€‰æ–¹æ¡ˆ | search-rpc æä¾›åŒæ­¥ç´¢å¼•æ¥å£ä½œä¸º Kafka å¤‡é€‰ |

---

## 10. æœåŠ¡é…ç½®

### 10.1 ç«¯å£åˆ†é…

| æœåŠ¡ | HTTP/RPC ç«¯å£ | Prometheus ç«¯å£ |
|------|---------------|-----------------|
| search-api | 1004 | 4007 |
| search-rpc | 2004 | 4008 |
| search-job | - | - |

### 10.2 ä¾èµ–æœåŠ¡

| ä¾èµ– | åœ°å€ | ç”¨é€” |
|------|------|------|
| Elasticsearch | 127.0.0.1:9200 | æ–‡ä»¶ç´¢å¼•å­˜å‚¨å’Œæœç´¢ |
| Kafka | 127.0.0.1:9094 | æ–‡ä»¶äº‹ä»¶æ¶ˆè´¹ |

### 10.3 ES ç´¢å¼•é…ç½®

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|------|------|
| ç´¢å¼•åç§° | polaris_file | æ–‡ä»¶ç´¢å¼• |
| åˆ†ç‰‡æ•° | 1 | å¼€å‘ç¯å¢ƒå•åˆ†ç‰‡ |
| å‰¯æœ¬æ•° | 0 | å¼€å‘ç¯å¢ƒæ— å‰¯æœ¬ |

---

## 11. å¯åŠ¨é¡ºåº

```bash
# 1. ç¡®ä¿ Elasticsearch å·²å¯åŠ¨
# 2. ç¡®ä¿ Kafka å·²å¯åŠ¨

# 3. å¯åŠ¨ search-rpcï¼ˆä¼šè‡ªåŠ¨åˆ›å»º ES ç´¢å¼•ï¼‰
go run app/search/cmd/rpc/search.go

# 4. å¯åŠ¨ search-jobï¼ˆKafka æ¶ˆè´¹è€…ï¼‰
go run app/search/cmd/job/search-job.go

# 5. å¯åŠ¨ search-api
go run app/search/cmd/api/search.go
```

---
