# Share 服务完整设计解析

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Share 服务                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────┐         RPC 调用        ┌─────────────────────┐        │
│  │     share-api       │  ───────────────────>   │    share-rpc        │        │
│  │   (HTTP Gateway)    │                         │   (业务核心)         │        │
│  │   Port: 1003        │                         │   Port: 2003        │        │
│  └─────────────────────┘                         └─────────────────────┘        │
│           │                                               │                     │
│           │                                               │                     │
│           ▼                                               │                     │
│  ┌─────────────────────┐                                  │                     │
│  │  JWT 认证中间件      │                                  │                     │
│  │ (部分接口需要认证)   │                                  │                     │
│  └─────────────────────┘                                  │                     │
│                                                           │                     │
│           ┌───────────────────────────────────────────────┤                     │
│           │                                               │                     │
│           ▼                                               ▼                     │
│  ┌─────────────────────┐                         ┌─────────────────────┐        │
│  │   usercenter-rpc    │                         │      MySQL          │        │
│  │   (获取用户信息)     │                         │   polaris_share     │        │
│  │   (配额管理)        │                         │   └── share         │        │
│  └─────────────────────┘                         └─────────────────────┘        │
│                                                                                 │
│           ┌─────────────────────────────────────────────────────────────┐       │
│           │                                                             │       │
│           ▼                                                             ▼       │
│  ┌─────────────────────┐                                       ┌──────────────┐ │
│  │     file-rpc        │                                       │    Redis     │ │
│  │   (获取文件信息)     │                                       │  (sqlc 缓存) │ │
│  │   (复制文件)        │                                       └──────────────┘ │
│  │   (获取下载链接)     │                                                       │
│  └─────────────────────┘                                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据模型

### 2.1 share 表

```sql
CREATE TABLE `share` (
    `id`                  bigint unsigned NOT NULL AUTO_INCREMENT,
    `identity`            varchar(36)  NOT NULL DEFAULT '' COMMENT '分享唯一标识(UUID)',
    `user_id`             bigint unsigned NOT NULL DEFAULT '0' COMMENT '分享者ID',
    `repository_identity` varchar(36)  NOT NULL DEFAULT '' COMMENT '关联文件Identity',
    `code`                varchar(10)  NOT NULL DEFAULT '' COMMENT '提取码(空=无需提取码)',
    `click_num`           int unsigned NOT NULL DEFAULT '0' COMMENT '点击/访问次数',
    `expired_time`        int unsigned NOT NULL DEFAULT '0' COMMENT '失效时间戳(0=永久有效)',
    `status`              tinyint(1)   NOT NULL DEFAULT '0' COMMENT '状态 0:正常 1:已封禁',
    `version`             bigint unsigned NOT NULL DEFAULT '0' COMMENT '乐观锁',
    `del_state`           tinyint(1)   NOT NULL DEFAULT '0' COMMENT '0:正常 1:已取消',
    `delete_time`         bigint unsigned NOT NULL DEFAULT '0' COMMENT '删除时间戳',
    `create_time`         timestamp DEFAULT CURRENT_TIMESTAMP,
    `update_time`         timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    KEY `idx_identity` (`identity`) USING BTREE,
    KEY `idx_user_id` (`user_id`)
);
```

**设计要点**：
- `identity`：UUID，对外暴露的分享链接标识
- `repository_identity`：关联 file 服务的文件 Identity
- `code`：提取码，为空表示无需提取码（公开分享）
- `expired_time`：过期时间戳，0 表示永久有效
- `status`：用于管理员封禁违规分享
- `del_state`：软删除，用户取消分享时标记

---

## 3. API 接口设计

### 3.1 对外 HTTP 接口 (share-api)

| 分类 | 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|------|
| **分享管理** | POST | `/share/v1/create` | ✅ JWT | 创建分享 |
| | GET | `/share/v1/list` | ✅ JWT | 我的分享列表 |
| | POST | `/share/v1/cancel` | ✅ JWT | 取消分享（批量） |
| | PUT | `/share/v1/update` | ✅ JWT | 更新分享设置 |
| **公开访问** | GET | `/share/v1/detail` | ❌ | 获取分享详情 |
| | GET | `/share/v1/download` | ❌ | 获取下载链接 |
| **保存分享** | POST | `/share/v1/save` | ✅ JWT | 保存到我的网盘 |

### 3.2 内部 RPC 接口 (share-rpc)

| 分类 | 方法 | 调用者 | 说明 |
|------|------|--------|------|
| **管理** | `CreateShare` | share-api | 创建分享记录 |
| | `GetShareList` | share-api | 获取用户分享列表 |
| | `CancelShare` | share-api | 批量取消分享 |
| | `UpdateShare` | share-api | 更新分享设置 |
| **访问** | `GetShareDetail` | share-api | 获取分享详情（含文件信息） |
| | `GetShareDownloadUrl` | share-api | 获取下载链接 |
| | `SaveShare` | share-api | 保存到网盘（跨用户复制） |
| **内部** | `ValidateShare` | 内部 | 验证分享有效性 |
| | `IncrClickNum` | 内部 | 增加点击次数 |
| | `GetShareByIdentity` | 其他服务 | 根据标识获取分享 |

---

## 4. 核心业务流程

### 4.1 创建分享流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          CreateShare 流程                                │
└─────────────────────────────────────────────────────────────────────────┘

用户请求 ──> share-api ──> share-rpc
                              │
                              ▼
                    ┌─────────────────┐
                    │ 1. 验证文件存在  │  调用 file-rpc.GetFileInfo
                    │    且属于用户    │
                    └────────┬────────┘
                             │ 文件存在
                             ▼
                    ┌─────────────────┐
                    │ 2. 生成分享标识  │  identity = UUID
                    │    生成提取码    │  code = 随机4位（如需要）
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 3. 计算过期时间  │  expiredType: 0永久/7天/30天
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 4. 插入分享记录  │  INSERT INTO share
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 5. 返回分享链接  │  {identity, code, url}
                    └─────────────────┘
```

### 4.2 访问分享流程（公开接口）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          GetShareDetail 流程                             │
└─────────────────────────────────────────────────────────────────────────┘

访问者请求 ──> share-api ──> share-rpc
                              │
                              ▼
                    ┌─────────────────┐
                    │ 1. ValidateShare│  验证分享有效性
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │ 检查存在  │  │ 检查过期  │  │ 检查封禁  │
        └──────────┘  └──────────┘  └──────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 2. 验证提取码    │  share.code == input.code
                    └────────┬────────┘
                             │ 验证通过
                             ▼
                    ┌─────────────────┐
                    │ 3. 增加点击次数  │  click_num++
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
        ┌──────────┐  ┌──────────┐  ┌──────────┐
        │获取分享者 │  │获取文件   │  │获取子文件 │
        │ 信息     │  │ 信息     │  │ (文件夹)  │
        │usercenter│  │ file-rpc │  │ file-rpc │
        └──────────┘  └──────────┘  └──────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 4. 返回详情      │  {file, sharerName, children}
                    └─────────────────┘
```

### 4.3 保存分享到网盘流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          SaveShare 流程                                  │
└─────────────────────────────────────────────────────────────────────────┘

保存者请求 ──> share-api ──> share-rpc
                              │
                              ▼
                    ┌─────────────────┐
                    │ 1. ValidateShare│  验证分享有效性
                    └────────┬────────┘
                             │ 验证通过
                             ▼
                    ┌─────────────────┐
                    │ 2. 计算文件大小  │  调用 file-rpc.GetFileInfo
                    │    (多个文件)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 3. 验证保存者    │  usedSize + totalSize <= totalSize
                    │    配额是否足够  │  调用 usercenter-rpc.GetUserQuota
                    └────────┬────────┘
                             │ 配额充足
                             ▼
                    ┌─────────────────┐
                    │ 4. 扣除配额      │  调用 usercenter-rpc.DeductQuota
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────────────────────────┐
                    │ 5. 跨用户复制文件                     │
                    │    调用 file-rpc.CopyFiles          │
                    │    UserId: 分享者ID（源文件所有者）   │
                    │    TargetUserId: 保存者ID           │
                    │    TargetId: 保存者目标文件夹        │
                    └────────────────┬────────────────────┘
                                     │
                          ┌──────────┴──────────┐
                          │ 成功                │ 失败
                          ▼                     ▼
                    ┌───────────┐         ┌───────────┐
                    │ 返回成功   │         │ 退还配额   │
                    │ savedCount│         │ RefundQuota│
                    └───────────┘         └───────────┘
```

### 4.4 分享验证流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          ValidateShare 验证逻辑                          │
└─────────────────────────────────────────────────────────────────────────┘

                              输入: {identity, code}
                                     │
                                     ▼
                    ┌─────────────────────────────────┐
                    │  1. 查询分享记录                  │
                    │     FindOneByIdentity(identity) │
                    └────────────────┬────────────────┘
                                     │
                         ┌───────────┴───────────┐
                         │                       │
                    未找到                    找到
                         │                       │
                         ▼                       ▼
                ┌──────────────┐      ┌─────────────────┐
                │ 返回: 无效    │      │ 2. 检查是否封禁  │
                │ 分享不存在    │      │    status == 1?  │
                └──────────────┘      └────────┬────────┘
                                               │
                                    ┌──────────┴──────────┐
                                    │                     │
                               封禁                    正常
                                    │                     │
                                    ▼                     ▼
                          ┌──────────────┐     ┌─────────────────┐
                          │ 返回: 无效    │     │ 3. 检查是否过期  │
                          │ 分享已被封禁  │     │ now > expiredTime│
                          └──────────────┘     │ (expiredTime > 0)│
                                               └────────┬────────┘
                                                        │
                                             ┌──────────┴──────────┐
                                             │                     │
                                        过期                    未过期
                                             │                     │
                                             ▼                     ▼
                                   ┌──────────────┐     ┌─────────────────┐
                                   │ 返回: 无效    │     │ 4. 验证提取码    │
                                   │ 分享已过期    │     │ share.code != ""│
                                   └──────────────┘     │ && code != share.code│
                                                        └────────┬────────┘
                                                                 │
                                                      ┌──────────┴──────────┐
                                                      │                     │
                                                 提取码错误             验证通过
                                                      │                     │
                                                      ▼                     ▼
                                            ┌──────────────┐     ┌──────────────┐
                                            │ 返回: 无效    │     │ 返回: 有效    │
                                            │ 提取码错误    │     │ + 分享信息    │
                                            └──────────────┘     └──────────────┘
```

---

## 5. 跨服务调用关系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              服务依赖关系图                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

                         ┌──────────────────────────────────────┐
                         │              share-rpc                │
                         │              Port: 2003               │
                         └──────────────────────────────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
         ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
         │  usercenter-rpc │   │    file-rpc     │   │      MySQL      │
         │   Port: 2001    │   │   Port: 2002    │   │  polaris_share  │
         └─────────────────┘   └─────────────────┘   └─────────────────┘
                │                       │
        ┌───────┴───────┐       ┌───────┴───────┐
        ▼               ▼       ▼               ▼
  ┌──────────┐    ┌──────────┐ ┌──────────┐ ┌──────────┐
  │GetUserInfo│   │DeductQuota│ │GetFileInfo│ │CopyFiles │
  │(分享者名)  │   │(保存配额) │ │(验证文件) │ │(跨用户)  │
  └──────────┘    └──────────┘ └──────────┘ └──────────┘
                  │RefundQuota│ │GetDownUrl │
                  │(退还配额) │ │(下载链接) │
                  └──────────┘ └──────────┘
```

---

## 6. 错误码设计

| 错误码 | 常量 | 说明 |
|--------|------|------|
| 400001 | SHARE_NOT_EXIST | 分享不存在 |
| 400002 | SHARE_EXPIRED | 分享已过期 |
| 400003 | SHARE_CODE_ERROR | 提取码错误 |
| 400004 | SHARE_CANCELLED | 分享已取消 |
| 400005 | SHARE_BANNED | 分享已被封禁 |
| 400006 | SHARE_FILE_NOT_EXIST | 分享的文件不存在 |
| 400007 | SHARE_CREATE_FAILED | 创建分享失败 |
| 400008 | SHARE_ALREADY_EXISTS | 该文件已被分享 |
| 400009 | SHARE_SAVE_FAILED | 保存分享失败 |
| 400010 | SHARE_PERMISSION_DENIED | 无权操作此分享 |

---

## 7. 可优化点分析

### 🔴 高优先级

#### 7.1 分享详情缺少 Redis 缓存

**当前问题**：每次访问分享详情都查询数据库

**优化方案**：
```go
// 热门分享缓存（短时间，如 5 分钟）
key := fmt.Sprintf("share:detail:%s", identity)
cached, err := redis.Get(key)
if err == nil && cached != "" {
    return unmarshal(cached), nil
}
// 查询数据库后写入缓存
redis.Setex(key, json.Marshal(detail), 300)
```

#### 7.2 点击次数高并发问题

**当前问题**：每次访问直接 UPDATE 数据库

**优化方案**：
```go
// 方案1: Redis 累加，定时同步到数据库
redis.Incr(fmt.Sprintf("share:click:%s", identity))
// 定时任务同步到 MySQL

// 方案2: 异步更新
go func() {
    l.svcCtx.ShareModel.IncrClickNum(ctx, identity)
}()
```

#### 7.3 保存分享时文件夹大小计算不准确

**当前问题**：只计算了根文件大小，文件夹内的文件未递归计算

**优化方案**：
```go
// 调用 file-rpc 获取文件夹的总大小
// 或在 file-rpc 中实现 GetFolderSize 方法
```

---

### 🟡 中优先级

#### 7.4 缺少分享链接短码功能

**当前问题**：分享链接包含完整 UUID

**优化方案**：
```go
// 生成 6-8 位短码
shortCode := base62.Encode(id)
// 短码 -> identity 映射存储在 Redis
```

#### 7.5 缺少分享密码强度验证

**当前问题**：提取码可以是任意字符

**优化方案**：限制提取码为 4-6 位字母数字组合

#### 7.6 缺少批量分享功能

**当前问题**：每次只能分享一个文件/文件夹

**优化方案**：支持多选文件生成一个分享链接

---

### 🟢 低优先级

#### 7.7 缺少分享统计功能

**当前问题**：只有简单的点击次数

**优化方案**：
- 访问来源统计
- 下载次数统计
- 保存次数统计
- 访问时间分布

#### 7.8 缺少分享预览功能

**当前问题**：访问分享只能下载

**优化方案**：支持图片、PDF、Office 等文件在线预览

#### 7.9 缺少分享转发功能

**当前问题**：保存分享后无法追踪来源

**优化方案**：记录保存关系链

---

## 8. 优化优先级总结

| 优先级 | 优化项 | 影响 | 复杂度 |
|--------|--------|------|--------|
| 🔴 高 | 分享详情 Redis 缓存 | 性能 | 低 |
| 🔴 高 | 点击次数异步更新 | 性能 | 低 |
| 🔴 高 | 文件夹大小递归计算 | 数据准确性 | 中 |
| 🟡 中 | 分享短链接 | 用户体验 | 中 |
| 🟡 中 | 提取码强度验证 | 安全性 | 低 |
| 🟡 中 | 批量分享 | 功能完整性 | 中 |
| 🟢 低 | 分享统计 | 功能完整性 | 高 |
| 🟢 低 | 在线预览 | 用户体验 | 高 |
| 🟢 低 | 分享转发追踪 | 功能完整性 | 中 |

---

## 9. 当前设计的优点

| 优点 | 说明 |
|------|------|
| ✅ 公开接口分离 | detail/download 无需登录，便于分享传播 |
| ✅ 提取码可选 | 支持公开分享和私密分享两种模式 |
| ✅ 过期时间灵活 | 支持永久/1天/7天/30天等多种选项 |
| ✅ 跨用户复制 | 保存分享时正确处理文件归属 |
| ✅ 配额联动 | 保存分享会扣除保存者配额 |
| ✅ 软删除 | 取消分享不删除数据，便于恢复 |
| ✅ 乐观锁 | 防止并发更新冲突 |
| ✅ 封禁机制 | 支持管理员封禁违规分享 |

---

## 10. 服务配置

### 10.1 端口分配

| 服务 | HTTP 端口 | Prometheus 端口 |
|------|-----------|-----------------|
| share-api | 1003 | 4005 |
| share-rpc | 2003 | 4006 |

### 10.2 依赖服务

| 依赖 | 地址 | 用途 |
|------|------|------|
| usercenter-rpc | 127.0.0.1:2001 | 用户信息、配额管理 |
| file-rpc | 127.0.0.1:2002 | 文件信息、复制、下载 |
| MySQL | 127.0.0.1:33069 | 分享数据存储 |
| Redis | 127.0.0.1:36379 | sqlc 缓存 |

---
